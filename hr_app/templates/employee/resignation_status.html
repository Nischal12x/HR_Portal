{% extends "main1.html" %}
{% load static %}

{% block title %}Resignation Status{% endblock %}

{% block content %}
<div class="wrapper">
  {% include 'navbar.html' %}
  {% include 'sidebar.html' %}

  <div class="content-wrapper">
    <section class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <h1>Resignation Status</h1>
          </div>
          <div class="col-sm-6">
            <ol class="breadcrumb float-sm-right">
              <li class="breadcrumb-item"><a href="{% url 'index' %}">Dashboard</a></li>
              <li class="breadcrumb-item active">Resignation Status</li>
            </ol>
          </div>
        </div>
      </div>
    </section>

    <section class="content">
      <div class="container-fluid">
        {% if exit_request %}
        <div class="row">
          <!-- Left Column: Request Details -->
          <div class="col-md-8">
            <div class="card card-primary card-outline">
              <div class="card-header">
                <h3 class="card-title font-weight-bold">Your Resignation Request Details</h3>
              </div>
              <div class="card-body">

                <!-- Status Badge and Message -->
                <div class="mb-4">
                  <h5>Current Status:
                    {% if exit_request.status == 'PENDING_RM_APPROVAL' %}
                      <span class="badge badge-warning">Pending Approval</span>
                    {% elif exit_request.status == 'APPROVED' %}
                      <span class="badge badge-success">Approved</span>
                    {% elif exit_request.status == 'REJECTED' %}
                      <span class="badge badge-danger">Rejected</span>
                    {% else %}
                      <span class="badge badge-secondary">{{ exit_request.status|title }}</span>
                    {% endif %}
                  </h5>

                  {% if exit_request.status == 'PENDING_RM_APPROVAL' %}
                    <div class="alert alert-info mt-3">Your request has been submitted and is awaiting approval from your reporting manager.</div>
                  {% elif exit_request.status == 'APPROVED' %}
                    <div class="alert alert-success mt-3">Your resignation has been approved. HR will be in touch shortly with details about the exit process.</div>
                  {% elif exit_request.status == 'REJECTED' %}
                    <div class="alert alert-danger mt-3">Your resignation request has been rejected. Please contact your reporting manager for more information.</div>
                  {% endif %}
                </div>

                <hr>

                <!-- Submitted Information -->
                <h5 class="mt-4 font-weight-bold">Submitted Information</h5>
                <div class="row mt-3">
                  <div class="col-md-6">
                    <p><strong>Department:</strong> {{ employee.department }}</p>
                    <p><strong>Designation:</strong> {{ employee.designation }}</p>
                    <p><strong>Reason for Resignation:</strong> {{ exit_request.reason_for_resignation }}</p>
                  </div>
                  <div class="col-md-6">
                    <p><strong>Resignation Apply Date:</strong> {{ exit_request.resignation_apply_date|date:"F d, Y" }}</p>
                    <p><strong>Calculated Last Working Day:</strong> {{ exit_request.last_working_date|date:"F d, Y" }}</p>
                  </div>
                </div>

              </div>
              <div class="card-footer">
                <p class="text-muted small">If you have any questions, please contact your reporting manager or the HR department.</p>
              </div>
            </div>
          </div>

          <!-- Right Column: Activity Timeline -->
          <div class="col-md-4">
  <div class="card shadow-sm">
    <div class="card-header">
      <h3 class="card-title font-weight-bold mb-0">
        <i class="fas fa-history mr-2"></i>Activity Timeline
      </h3>
    </div>
    <div class="card-body">
      <div class="timeline">

        <!-- ===== 1. SUBMISSION ITEM (Always shows) ===== -->
        <div class="time-label">
          <span class="bg-primary">{{ exit_request.resignation_apply_date|date:"M d, Y" }}</span>
        </div>
        <div>
          <i class="fas fa-paper-plane bg-primary"></i>
          <div class="timeline-item">
            <span class="time"><i class="fas fa-clock"></i> {{ exit_request.created_at|timesince }} ago</span>
            <h3 class="timeline-header"><a href="#">{{ exit_request.employee.full_name }}</a> submitted the request</h3>
            <div class="timeline-body">
              The exit process has been initiated and sent for manager's approval.
            </div>
          </div>
        </div>
        <!-- END SUBMISSION ITEM -->


        <!-- ===== 2. MANAGER ACTION ITEM (Shows if manager has acted) ===== -->
        {% if exit_request.reporting_manager_approved_at %}
          <div class="time-label">
            <span class="bg-info">{{ exit_request.reporting_manager_approved_at|date:"M d, Y" }}</span>
          </div>
          <div>
            <i class="fas fa-user-check bg-info"></i>
            <div class="timeline-item">
              <span class="time"><i class="fas fa-clock"></i> {{ exit_request.reporting_manager_approved_at|timesince }} ago</span>
              <h3 class="timeline-header no-border">Approved by Manager</h3>
              <div class="timeline-body">
                The request was approved by the reporting manager and forwarded to HR for final processing.
                {% if exit_request.reporting_manager_remarks %}
                  <hr class="my-2">
                  <strong>Remarks:</strong> <em>"{{ exit_request.reporting_manager_remarks }}"</em>
                {% endif %}
              </div>
            </div>
          </div>
        {% elif exit_request.status == 'REJECTED_BY_RM' %}
          <div class="time-label">
            <span class="bg-danger">{{ exit_request.updated_at|date:"M d, Y" }}</span>
          </div>
          <div>
            <i class="fas fa-user-times bg-danger"></i>
            <div class="timeline-item">
              <span class="time"><i class="fas fa-clock"></i> {{ exit_request.updated_at|timesince }} ago</span>
              <h3 class="timeline-header no-border">Rejected by Manager</h3>
              <div class="timeline-body">
                The request was rejected by the reporting manager.
                {% if exit_request.reporting_manager_remarks %}
                   <hr class="my-2">
                   <strong>Reason:</strong> <em>"{{ exit_request.reporting_manager_remarks }}"</em>
                {% endif %}
              </div>
            </div>
          </div>
        {% endif %}
        <!-- END MANAGER ACTION ITEM -->


        <!-- ===== 3. HR ACTION ITEM (Shows if HR has acted) ===== -->
        {% if exit_request.hr_approved_at %}
          <div class="time-label">
            <span class="bg-success">{{ exit_request.hr_approved_at|date:"M d, Y" }}</span>
          </div>
          <div>
            <i class="fas fa-check-circle bg-success"></i>
            <div class="timeline-item">
              <span class="time"><i class="fas fa-clock"></i> {{ exit_request.hr_approved_at|timesince }} ago</span>
              <h3 class="timeline-header no-border">Approved by HR</h3>
              <div class="timeline-body">
                The exit request has been formally approved. Offboarding can now be completed.
              </div>
            </div>
          </div>
        {% elif exit_request.status == 'REJECTED_BY_HR' %}
          <div class="time-label">
            <span class="bg-danger">{{ exit_request.updated_at|date:"M d, Y" }}</span>
          </div>
          <div>
            <i class="fas fa-times-circle bg-danger"></i>
            <div class="timeline-item">
              <span class="time"><i class="fas fa-clock"></i> {{ exit_request.updated_at|timesince }} ago</span>
              <h3 class="timeline-header no-border">Rejected by HR</h3>
              <div class="timeline-body">
                The exit request was rejected by HR.
                {% if exit_request.hr_remarks %}
                   <hr class="my-2">
                   <strong>Reason:</strong> <em>"{{ exit_request.hr_remarks }}"</em>
                {% endif %}
              </div>
            </div>
          </div>
        {% endif %}
        <!-- END HR ACTION ITEM -->


        <!-- End of Timeline Icon -->
        <div>
          <i class="fas fa-clock bg-gray"></i>
        </div>

      </div>
      <!-- END Timeline -->
    </div>
  </div>
</div>
        </div>
        {% else %}
          <div class="callout callout-info">
            <h4>No Resignation Request Found</h4>
            <p>You have not submitted any resignation requests yet. You can apply for resignation from the Exit Management section.</p>
            <a href="{% url 'apply_resignation' %}" class="btn btn-primary mt-2">Apply for Resignation</a>
          </div>
        {% endif %}
      </div>
    </section>
  </div>

  {% include 'footer.html' %}
</div>
{% endblock %}